---
title: "SEISMIC Equity Learning Communities "
subtitle: "Level 1 Report"
output:
  rmdformats::readthedown
date: "`r Sys.Date()`"
---
# Introduction

This report is the first in a series created for the SEISMIC Equity Learning Communities (SELC) project. The goal of this report, as part of the SELC project, is to allow faculty and department leaders to view institutional data from their courses of interest to evaluate whether students experience equitable outcomes in those courses. This first "Level 1" report will give an overview of the demographic composition of these courses across a range of student identities, show how course grades map onto these demographics and how these patterns have changed over time, and will also compare course grades to students' other coursework through the concept of grade anomaly. This data is meant to facilitate discussions about how to improve equitable outcomes and elevate pedagogical techniques that might support historically marginalized students. 

We want to emphasize that the student identities explored here are not exhaustive. There are many identities that may influence students' experiences, and thus outcomes, in the classroom, and only some of these identities are collected in registrar-available or quantitative data. Quantitative data is readily-available and allows us to quickly show patterns across student groups or over time. However, aspects of quantitative analysis - such as the binary categorizations, or analyzing statistics aggregated over whole groups - can obscure many diverse and intersectional aspects of an individual student's experiences. As you read through the report, remember that each data point represents an individual who deserves the opportunity to succeed in these courses. 


```{r setup, include=FALSE}
#hide code, warnings, and messages by default
knitr::opts_chunk$set(echo = FALSE, warnings = FALSE, messages = FALSE)
library(tidyverse)
library(rmdformats) #output format: readthedown
library(kableExtra) #pretty html tables
library(gghalves) #for half-half geoms
library(ggdist) #for density plots 
library(cowplot) #for two panel plots

#create some plot settings
theme_seismic <- 
  theme_classic(base_size = 14) + 
  theme(axis.text = element_text(color = "black"), 
        strip.text = element_text(color = "black"), 
        panel.border = element_rect(color = "black", fill = NA, size = 1), 
        strip.background = element_rect(color = "black", size = 1))
```

```{r load data, echo = FALSE}
#load data 
#change this file name to the source of your properly formatted data file 
dat <- read.csv(file = "~/Downloads/synthetic_data_SEISMIC-format_BIO300_2023-04-27.csv")
```

```{r select course of interest, results = "asis"}
#if the dataset has more than one course in it, define the course of interest here
#what you enter must match the entry in the dataset
course_of_interest <- "BIO300"

#this command will include the selected course of interest in the R markdown report. 
#Do not edit this line:
cat(paste("The course of interest is:", course_of_interest))

#this command will include the range of dates in the R markdown report. 
#Do not edit this line:
cat("\n", paste("The range for this data is:", min(dat$crs_year), "-", max(dat$crs_year)))
```

```{r define majors of interest, include = FALSE}
majors_of_interest <- c("Biological Sciences", "Chemistry")
```

# Who is in this course?

Before evaluating student course outcomes, it is important to understand: who takes this course? What demographic and academic groups do students in this course hold? 

The plot below shows the percent of students across all terms of the course of interest that hold the following identities: declared a STEM major, transferred from another 2- or 4- year institution, are international students or are permament residents, come from a low socioeconomic family background, are the first in their family to go to college or pursue a Bachelor's degree (first-generation, or FirstGen), are women, or come from a background historically excluded from science based on ethnicity and/or race (PEER; Asai, 2020).

Note that these identities are not mutually exclusive; a single student can belong to any or all of these groups.

```{r percent by identity, message=FALSE, warning=FALSE}
#bar plot with percent of all students in the class by demographics

#underlying table

demog_percent <-
dat %>% 
  #select course of interest only
  filter(crs_name == course_of_interest) %>%
  #add n for all students in course
  add_tally(name = "n_course") %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(ethniccode_cat, female, firstgen, lowincomeflag, international, transfer, stem_major), 
               names_to = "demo_var",
               values_to = "value") %>% 
  group_by(demo_var, value) %>% 
  #count sample size by each group, then divide by course total
  summarise(n_total = n(),
            n_course = mean(n_course)) %>% 
  #convert to percent
  mutate(perc = n_total/n_course *100) %>% #percent for each level
  #select only students that belong to marginalized backgrounds
  filter(value == 1)

#plot ####

demog_percent %>%
  #rename labels to be more interpretable
  mutate(demo_var = factor(demo_var, 
                           levels = c("ethniccode_cat","female","firstgen","lowincomeflag","international","transfer", "stem_major"),
                           labels = c("PEER", "Woman", "FirstGen", "LowIncome", "International", "Transfer", "STEM Major"))) %>%
ggplot(aes(x = demo_var, y = perc, fill = demo_var)) + 
  #add barplot for percent
  geom_col(color = "black") + 
  #add labels for actual percent values
  geom_text(aes(label = round(perc,0)), hjust = -1) + 
  labs(x = "Student identity", y = "Percent of class (%)") + 
  #set y axis to 100
  ylim(0,100)+
  theme_seismic +
  #hide redundant color legend
  theme(legend.position = "none") + 
  coord_flip()
```
Persons historically excluded based on ethnicity or race (PEER; Asai 2020) is a category that includes Black/African-American, Indigenous/Native American, and Hispanic/Latino/a/x students. The definition of PEER closely aligns with the defintiion of "underrepresented minorities" used by the National Science Foundation (NSF 2019). 

However, the different racial and ethnic groups included in the PEER label may have different experiences in the STEM courses. These diverse experiences may be masked by the overall PEER/non-PEER categorization; certain ethnicities may experience more or less equitable outcomes. For this reason, it is also important to disaggregate our data by student ethnicity. 

The following plot shows the percent of students in the course of interest (across all terms), broken down by specific racial/ethnicity.

```{r percent by ethnicity, message=F, warning=F}
#Create a list of labels of ethnicities to be more interpretable for x axis labels
ethnicity_labels <- c("white"= "White", "black_afram" = "Black/African-American", "hispanic_latinx" = "Hispanic/Latinx/Chicanx", "indigenous_am_indian" = "Indigenous/American Indian", "asian" = "Asian", 
                      "pacific_islander" = "Pacific Islander/Native Hawaiian") 

#Breakdown of specific ethnicities: 
dat %>% 
  #select course of interest only
  filter(crs_name == course_of_interest) %>%
  #add n for all students in course
  add_tally(name = "n_course") %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(white, black_afram, hispanic_latinx, indigenous_am_indian, asian, pacific_islander),
               names_to = "ethnicity",
               values_to = "value") %>% 
  group_by(ethnicity, value) %>% 
  #count sample size by each group, then divide by course total
  summarise(n_total = n(),
            n_course = mean(n_course)) %>% 
  #convert to percent
  mutate(perc = n_total/n_course *100) %>% #percent for each level
  #select only students that belong to marginalized backgrounds
  filter(value == 1) %>%
  #PLOT #
  ungroup() %>%
  mutate(ethnicity = forcats::fct_reorder(ethnicity, desc(perc))) %>% 
ggplot(aes(x = ethnicity, y = perc, fill = ethnicity)) + 
  #add barplot for percent
  geom_col(color = "black") + 
  #add labels for actual percent values
  geom_text(aes(label = round(perc,0)), hjust = -1) + 
  labs(x = "Student ethnicity", y = "Percent of class (%)") + 
  #ylim
  ylim(0,100)+
  scale_x_discrete(labels = ethnicity_labels) + 
  theme_seismic +
  #hide redundant color legend
  theme(legend.position = "none") +
  coord_flip()

```

**Guiding questions:**

-   Do any of the percentages of students in the course surprise you? In what way?
- What groups are *not* included in these figures? 
-   Given the demographic breakdown of your course, are there any groups you would be specifically interested in examining course outcomes for?
-   Do you think it could be useful to show the demographic breakdown to your students? How might you present this data to your students?

## How have these demographics changed over time?

While overall percentages are informative, we can also examine trends in representation of these different student groups across course terms.

The below plot shows the percent of students in *each term* of the coures of interest across the range of terms in the dataset. Student identities are shown in different colored lines over time. Individual terms (winter, spring, summer or fall) are labeled on the x-axis. 

```{r percent by identity - over time, message=FALSE, warning=FALSE}
#different identities with the percent over time
  #could be facet grid or not

dat %>% 
  #select course of interest only
  filter(crs_name == course_of_interest) %>%
  #add n for all students in course section
  add_count(crs_section, name = "n_section") %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(ethniccode_cat, female, firstgen, lowincomeflag, international, transfer, stem_major), 
               names_to = "demo_var",
               values_to = "value") %>% 
  #group by course section
  group_by(crs_year, crs_semq, demo_var, value) %>% 
  #count sample size by each group, then divide by course total
  summarise(n_total = n(),
            n_course = mean(n_section)) %>% 
  #convert to percent
  mutate(perc = n_total/n_course *100) %>% #percent for each level
  #select only students that belong to marginalized backgrounds
  filter(value == 1) %>%
  #create a semq text label for more clear x axis labels 
  mutate(semq_text = recode(as.character(crs_semq), "1" = "W", "01" = "W", "03"= "Sp", "3" = "Sp", "05" = "SuI", "5" = "SuI", "07" = "SuII", "7" = "SuII", "10" = "F")) %>%
  #create a crs_section variable to maintain x axis chronological ordering
  mutate(crs_section = paste0(crs_year, crs_semq)) %>%
  #create course label that orders readable labels create above chronologically
  mutate(crs_label = forcats::fct_reorder(as.factor(paste0(semq_text, crs_year)), as.integer(crs_section))) %>%
  #rename demographic labels to be more interpretable
  mutate(demo_var = factor(demo_var, 
                           levels = c("ethniccode_cat","female","firstgen","lowincomeflag","international","transfer", "stem_major"),
                           labels = c("PEER", "Woman", "FirstGen", "LowIncome", "International", "Transfer", "STEM Major"))) %>%
  #remove missing demographic variables before plotting
  drop_na(demo_var) %>%
  #PLOT 
ggplot(aes(x = crs_label, y = perc, color = demo_var)) + 
  geom_point(aes(shape = semq_text), size = 2) + #shape corresponds to term
  geom_line(aes(group = demo_var)) + 
  labs(x = "Course Term", y = "Percent of class (%)",
       color = "Student identity", shape = NULL) + 
  #optional: separate plots for each demographic variable
  #facet_wrap(~demo_var) + 
  scale_shape_discrete(labels = c("F" = "Fall", "Sp" = "Spring", "W" = "Winter", "SuI" = "Summer I", "SuII" = "Summer II")) +
  theme_seismic + 
  theme(axis.text.x = element_text(angle = 90))

```

**Guiding questions:**

-   What groups, if any, are growing in the classroom in recent years?
- Are there any yearly patterns or differences between summer terms and main terms?
-   Are there any change to the classroom course content or structure that could better meet the needs or specific challenges of these groups?

### Student Majors 

```{r percent ~ majors of interest, message=FALSE, warning=FALSE}
#plot of the percent of only majors of interest (defined above)

dat %>% 
  #select course of interest only
  filter(crs_name == course_of_interest) |>
  #add n for all students in course
  add_tally(name = "n_course") %>%
  #select majors of interest only (defined above)
  filter(major %in% majors_of_interest) %>%
  group_by(major, stem_major) %>% 
  #count sample size by each group, then divide by course total
  summarise(n_total = n(),
            n_course = mean(n_course)) %>% 
  #convert to percent
  mutate(perc = n_total/n_course *100) |> #percent for each level
  ggplot(aes(x = major, y = perc, fill = major)) + 
  #add barplot for percent
  geom_col(color = "black") + 
  #add labels for actual percent values
  geom_text(aes(label = round(perc,0)), hjust = 1.2) + 
  labs(x = "Major", y = "Percent of class (%)") + 
  theme_seismic +
  #hide redundant color legend
  theme(legend.position = "none") + 
  coord_flip()
```

# Grades in this course

## How do course outcomes compare for different student groups?

```{r raw grades ~ identity, message=FALSE, warning=FALSE}
#mean grades (+/-SEM) for different identities

#calculate overall mean grade for course (will be plotted as an average line)
mean_grade_coi <- mean(dat$numgrade[dat$crs_name == course_of_interest], na.rm = T)

dat %>%
  filter(crs_name == course_of_interest) %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(ethniccode_cat, female, firstgen, lowincomeflag, international, transfer, stem_major), 
               names_to = "demo_var",
               values_to = "value") %>% 
  #select all students who do belong to the group of interest
  filter(value == 1 ) %>%
  #rename labels to be more interpretable
 mutate(demo_var = factor(demo_var, 
                           levels = c("ethniccode_cat","female","firstgen","lowincomeflag","international","transfer", "stem_major"),
                           labels = c("PEER", "Woman", "FirstGen", "LowIncome", "International", "Transfer", "STEM Major"))) %>%
  add_count(demo_var, name = "n") %>%
  #PLOT
  ggplot(aes(x = demo_var, y = numgrade, color = demo_var)) + 
  #points for mean
  stat_summary(aes(size = n), geom = "point", fun = "mean") + 
  #add 95% CI errorbars
  stat_summary(geom = "errorbar", fun.data = "mean_cl_normal", width = 0.1) + 
  #plot average line for mean grade
  geom_hline(yintercept = mean_grade_coi, linetype = "dashed") +
  #labels
  labs(x = "Student identity", y = "Average grade", color = "Student identity",
       caption = "Mean Â± 95% CI shown \n Dashed line is overall average grade") + 
  theme_seismic + 
  coord_flip()
```

However, means and standard errors only tell part of the story. We can also examine the full distribution of the grades for each identity. The plot below shows the distribution (density plot), with the majority (25th - 75th percentiles) shaded in the darker color. Means are plotted as points along with standard errors.

```{r raw grade distributions by identity, message=FALSE, warning=FALSE}
#plots grade distributions, along with means/SEM, for demographic identities

dat %>%
  filter(crs_name == course_of_interest) %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(ethniccode_cat, female, firstgen, lowincomeflag, international, transfer, stem_major), 
               names_to = "demo_var",
               values_to = "value") %>% 
  #select all students who do belong to the group of interest
  filter(value == 1 ) %>%
  #rename labels to be more interpretable
 mutate(demo_var = factor(demo_var, 
                           levels = c("ethniccode_cat","female","firstgen","lowincomeflag","international","transfer", "stem_major"),
                           labels = c("PEER", "Woman", "FirstGen", "LowIncome", "International", "Transfer", "STEM Major"))) %>%
  ggplot(aes(x = demo_var, y = numgrade, fill = demo_var)) + 
  #add density half-plot with the 1st and 3rd quartiles demarcated
  ggdist::stat_slab(side = "right", scale = 0.4, show.legend = F,
                    position = position_dodge(width = 0.8),
                    aes(fill_ramp = after_stat(level)),.width = c(.50, .95,1)) + 
  #add mean +/- sem piint
  stat_summary(fun.data = "mean_cl_normal", show.legend = T, 
               size = 0.3, position = position_dodge2(width = 0.8)) +
  geom_hline(yintercept = mean_grade_coi, linetype = "dashed") + 
  theme_seismic + 
  theme(legend.position = "none") + 
  guides(fill_ramp = "none") + 
  labs(x = NULL, y = "Course grade",
       caption = "Shaded part of distribution is the 1st-3rd quartiles (25-75%iles)
       \n Points show means +/- SEM",
       ) + 
  coord_flip()
```

```{r raw grade ~ ethnicity, message=FALSE, warning=FALSE}
# raw grade (mean and SEM) by specific ethnicities

dat %>%
  filter(crs_name == course_of_interest) %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(white, black_afram, hispanic_latinx, indigenous_am_indian, asian, pacific_islander),
               names_to = "ethnicity",
               values_to = "value") %>% 
  #select all students who do belong to the group of interest
  filter(value == 1 ) %>%
  mutate(ethnicity = fct_reorder(ethnicity, numgrade, .fun = "mean")) %>%
  add_count(ethnicity, name = "n") %>%
  #PLOT
  ggplot(aes(x = ethnicity, y = numgrade, color = ethnicity)) + 
  #points for mean
  stat_summary(aes(size = n), geom = "point", fun = "mean") + 
  #add 95% CI errorbars
  stat_summary(geom = "errorbar", fun.data = "mean_cl_normal", width = 0.1) + 
  #plot average line for mean grade
  geom_hline(yintercept = mean_grade_coi, linetype = "dashed") +
  #relabel x axis labels to be more interpretable
  scale_x_discrete(labels = ethnicity_labels) + 
  #labels
  labs(x = "Student identity", y = "Average grade", color = "Student identity",
       caption = "Mean Â± 95% CI shown \n Dashed line is overall average grade") + 
  coord_flip()+
  theme_seismic +
  theme(legend.position = "none") + 
  coord_flip()
```

## How does overall prior performance at the university (i.e., GPAO, prior GPA) compare to student outcomes in my course?

One way we can compare outcomes in our course to students' prior performance at our institution is by calculating **grade anomaly**. Grade anomaly subtracts a measure of student's general or prior academic performance, such as prior GPA, from their course grade.

Grade anomalies can be:

-   **Grade penalties** - where students receive *lower* grades in the course relative to their other coursework, or,

-   **Grade bonuses** - where students receive *higher* grades relative to other courses.

SEISMIC projects often use grade point average omitting the course of interest (**GPAO**), because this metric has been found to be the best metric of prior academic preparation in previous studies (compared to high school GPA or standardized test scores, [Koester et al.,2016](https://doi.org/10.48550/arXiv.1608.07565)). GPAO can also be especially useful for transfer students, who may not have a prior GPA at our institution if they just transferred.

```{r grade anomaly ~ identity, message=FALSE, warning=FALSE}
#different identities with average grade anomaly across identities 

#calculate overall mean grade for course (will be plotted as an average line)
aga_coi <- mean(dat$numgrade[dat$crs_name == course_of_interest], na.rm = T) - 
           mean(dat$gpao[dat$crs_name == course_of_interest], na.rm = T)


dat %>%
  filter(crs_name == course_of_interest) %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(ethniccode_cat, female, firstgen, lowincomeflag, international, transfer, stem_major), 
               names_to = "demo_var",
               values_to = "value") %>% 
  #select all students who do belong to the group of interest
  filter(value == 1 ) %>%
  #rename labels to be more interpretable
 mutate(demo_var = factor(demo_var, 
                           levels = c("ethniccode_cat","female","firstgen","lowincomeflag","international","transfer", "stem_major"),
                           labels = c("PEER", "Woman", "FirstGen", "LowIncome", "International", "Transfer", "STEM Major")))%>%
  add_count(demo_var, name = "n") %>%
  #PLOT
  ggplot(aes(x = demo_var, y = numgrade-gpao, color = demo_var)) +   
  #points for mean
  stat_summary(aes(size = n), geom = "point", fun = "mean") + 
  #add 95% CI errorbars
  stat_summary(geom = "errorbar", fun.data = "mean_cl_normal", width = 0.1) + 
  #plot average line for mean grade
  geom_hline(yintercept = aga_coi, linetype = "dashed") +
  #plot line and annotations for penalty vs bonus
  geom_hline(yintercept = 0) +  
  annotate(geom = "text", x = 1, y = c(0.1,-0.1), label = c("grade \nbonus", "grade \npenalty"), color = c("blue", "red"), vjust = -0.1) + 
  #labels
  labs(x = "Student identity", y = "Grade anomaly \n(course grade-GPAO)", color = "Student identity",
       caption = "Mean Â± 95% CI shown \n Dashed line is course average grade anomaly") + 
  theme_seismic + 
  coord_flip()
```

[*Are plotting both boxplots, distributions, AND means useful in a single plot?*]{style="color: red;"}

```{r grade anomaly distributions, message=FALSE, warning=FALSE}
#grade anomaly distributions 

dat %>%
  filter(crs_name == course_of_interest) %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(ethniccode_cat, female, firstgen, lowincomeflag, international, transfer, stem_major), 
               names_to = "demo_var",
               values_to = "value") %>% 
  #select all students who do belong to the group of interest
  filter(value == 1 ) %>%
  #rename labels to be more interpretable
  mutate(demo_var = factor(demo_var, 
                           labels = c("PEER", "Woman", "FirstGen", "LowIncome", "International", "Transfer", "STEM Major"))) %>%
  ggplot(aes(x = demo_var, y = numgrade-gpao, fill = demo_var)) + 
  #add density half-plot with the 1st and 3rd quartiles demarcated
  ggdist::stat_slab(side = "right", scale = 0.4, show.legend = F,
                    position = position_dodge(width = 0.8),
                    aes(fill_ramp = after_stat(level)),.width = c(.50, .95,1)) + 
  #boxplots too
  geom_boxplot(width = .1,alpha = .5,outlier.alpha=0,
               position = position_dodge(width  = .8),show.legend = FALSE) +

  #add mean +/- sem piint
  stat_summary(fun.data = "mean_cl_normal", show.legend = T, 
               size = 0.3, position = position_dodge2(width = 0.8)) +
  #overall average line
  geom_hline(yintercept = aga_coi, linetype = "dashed") + 
  theme_seismic + 
  theme(legend.position = "none") + 
  guides(fill_ramp = "none") + 
  labs(x = NULL, y = "Grade anomaly \n (Grade - GPAO)",
       caption = "Shaded part of distribution is the 1st-3rd quartiles (25-75%iles)
       \n Points show means +/- SEM",
       ) + 
  coord_flip()
```

```{r grade anomaly ~ ethnicity, message=FALSE, warning=FALSE}
# plot grade anomaly by specific ethnicity

dat %>%
  filter(crs_name == course_of_interest) %>%
  #pivot to a long format dataframe
  pivot_longer(cols = c(white, black_afram, hispanic_latinx, indigenous_am_indian, asian, pacific_islander),
               names_to = "ethnicity",
               values_to = "value") %>% 
  #select all students who do belong to the group of interest
  filter(value == 1 ) %>%
  mutate(ethnicity = fct_reorder(ethnicity, numgrade-gpao, .fun = "mean")) %>%
  add_count(ethnicity, name = "n") %>%
  #PLOT
  ggplot(aes(x = ethnicity, y = numgrade-gpao, color = ethnicity)) + 
  #points for mean
  stat_summary(aes(size = n), geom = "point", fun = "mean") + 
  #add 95% CI errorbars
  stat_summary(geom = "errorbar", fun.data = "mean_cl_normal", width = 0.1) + 
  #plot average line for mean grade
  geom_hline(yintercept = aga_coi, linetype = "dashed") +
  geom_hline(yintercept = 0) + #plot the 0 line
  #relabel x axis labels to be more interpretable
  scale_x_discrete(labels = ethnicity_labels) + 
  scale_size_continuous(trans = "log10", breaks = c(10,100,1000))+ #point size for readability
  #labels
  labs(x = "Student identity", y = "Average grade anomaly", color = "Student identity",
       caption = "Mean Â± 95% CI shown \n Dashed line is overall average grade") + 
  theme_seismic +
  theme(legend.position = "none") + 
  coord_flip()
```

**Guiding questions:**

-   Are students receiving a grade bonus or a grade penalty on average in this course? (see dashed line for overall course average)
-   Are there any marginalized demographic groups that are receiving more of a grade penalty or more of a grade bonus? Reflecting on the course structure and its place in the curriculum context, can you think of any reasons that might be?

## How do course outcomes differ across the spectrum of systemic advantages students may have access to in higher education?

How can we view the cumulative effect of systemic advantages students may have access to (conferred by demographic identities) overall in the context of a course?

### SAI

SAI, or the **Systemic Advantage Index** is one approach. This metric takes into account multiple axes of student identities, including:

-   race/ethnicity

-   gender

-   socioeconomic status

-   parental education (i.e., first-generation college-going status)

SAI adds together all of the advantages a student may have across these four demographic axes and assigns an index. The table below shows SAI for multiple combinations of identities. For instance, a Latino, first-generation, low income man (column second from left) would be considered to have SAI = 1, while a white, continuing-generation woman from a high income family would be considered to have SAI = 3 (column second from right).

![](SAI_assignment.tif)

------------------------------------------------------------------------

> ðŸ’­ Can you think of any other systemic advantages not included in this index that likely influence student's outcomes in a course? What would be the challenges to adding those identities or advantages to this index?

------------------------------------------------------------------------
```{r default missing demographics to 0, message=FALSE, warning=FALSE}
#for SAI calculations, any NA demographic variables will need to be conservatively coded as 0 (defaulted to the majoritarian group)
#this allows those students to still be included in SAI calculations

#Convert Demographics to 0 (conservative, instead of excluding)
dat <-
  dat %>%
  mutate(across(.cols = c(ethniccode_cat, firstgen, female, lowincomeflag), as.character)) %>%
  tidyr::replace_na(list(ethniccode_cat = "0", firstgen = "0", female = "0", lowincomeflag = "0"))
```

```{r SAI calculation, message=FALSE, warning=FALSE}
#this code goes through all possible combinations of the 4 advantage axes and assigns an SAI based on that students' values
#as ethniccode_cat == 1 is the "BIPOC" label, all other categories are considered advantaged 
dat <-
  dat %>% mutate(sai = case_when(
    female == "0" & ethniccode_cat != "1" & firstgen == "0" & lowincomeflag == "0"  ~ "4",
    female == "1" & ethniccode_cat != "1" & firstgen == "0" & lowincomeflag == "0"  ~ "3",
    female == "0" & ethniccode_cat == "1" & firstgen == "0" & lowincomeflag == "0"  ~ "3", 
    female == "0" & ethniccode_cat != "1" & firstgen == "0" & lowincomeflag == "1"  ~ "3", 
    female == "0" & ethniccode_cat != "1" & firstgen == "1" & lowincomeflag == "0"  ~ "3", 
    female == "0" & ethniccode_cat == "1" & firstgen == "1" & lowincomeflag == "0"  ~ "2", 
    female == "0" & ethniccode_cat == "1" & firstgen == "0" & lowincomeflag == "1"  ~ "2", 
    female == "1" & ethniccode_cat == "1" & firstgen == "0" & lowincomeflag == "0"  ~ "2", 
    female == "0" & ethniccode_cat != "1" & firstgen == "1" & lowincomeflag == "1"  ~ "2", 
    female == "1" & ethniccode_cat != "1" & firstgen == "1" & lowincomeflag == "0"  ~ "2", 
    female == "1" & ethniccode_cat != "1" & firstgen == "0" & lowincomeflag == "1"  ~ "2", 
    female == "1" & ethniccode_cat != "1" & firstgen == "1" & lowincomeflag == "1"  ~ "1", 
    female == "1" & ethniccode_cat == "1" & firstgen == "1" & lowincomeflag == "0"  ~ "1",
    female == "1" & ethniccode_cat == "1" & firstgen == "0" & lowincomeflag == "1"  ~ "1", 
    female == "0" & ethniccode_cat == "1" & firstgen == "1" & lowincomeflag == "1"  ~ "1",
    female == "1" & ethniccode_cat == "1" & firstgen == "1" & lowincomeflag == "1"  ~ "0",
    TRUE ~ "NA"))
```

### How do course grades and grade anomalies compare across levels of SAI?

The below plots show raw grades and grade anomaly partitioned by the number of systemic advantages students have access to.

```{r raw grades by SAI, message=FALSE, warning=FALSE}
#raw grades by SAI
dat %>%
  mutate(sai = as.numeric(sai)) %>%
  add_count(sai, name = "n") %>% #add sample size per SAI
  filter(crs_name == course_of_interest) %>%
  ggplot(aes(x = sai, y = numgrade, color = sai))+ 
      stat_summary(aes(size = n), geom = "point", fun = "mean", 
                 position = position_dodge(0.2)) + 
    stat_summary(geom = "errorbar", fun.data = "mean_cl_normal", 
                 width = 0.1, position = position_dodge(0.2)) +
   geom_hline(yintercept = mean_grade_coi, linetype = "dashed") + 
  labs(x = "SAI", y = "Course grade", color = "SAI",
       caption = "Mean Â± 95% CI shown \n Dashed line is overall average grade") + 
  theme_seismic + 
  coord_flip()

```

```{r grade anomaly by SAI, message=FALSE, warning=FALSE}
#grade anomaly by SAI

dat %>%
  mutate(sai = as.numeric(sai)) %>%
  add_count(sai, name = "n") %>% #add sample size per SAI
  filter(crs_name == course_of_interest) %>%
  ggplot(aes(x = sai, y = numgrade-gpao, color = sai))+ 
      stat_summary(aes(size = n), geom = "point", fun = "mean", 
                 position = position_dodge(0.2)) + 
    stat_summary(geom = "errorbar", fun.data = "mean_cl_normal", 
                 width = 0.1, position = position_dodge(0.2)) +
   geom_hline(yintercept = aga_coi, linetype = "dashed") + 
    #plot line and annotations for penalty vs bonus
  geom_hline(yintercept = 0) +  
  annotate(geom = "text", x = 1, y = c(0.1,-0.1), label = c("grade \nbonus", "grade \npenalty"), color = c("blue", "red"), vjust = -0.1)  + 
  labs(x = "SAI", y = "Grade anomaly \n(course grade - GPAO)", color = "SAI",
       caption = "Mean Â± 95% CI shown \n Dashed line is overall average grade") + 
  theme_seismic + 
  coord_flip()

```

**Guiding questions:**

-   Are different levels of SAI significantly different from each other in terms of course outcomes (i.e., do 95% confidence intervals overlap)? Is there a linear relationship between SAI and grade, or is the relationship more mixed? Is there a point where students fall "below" average grades or grade anomalies? How can we better serve those students in this course?

-   If we see differences across levels of SAI, what elements of the course structure might lead to some of these differences with student systemic advantages?


### Acknowledgements

This report is heavily inspired by the Foundational Course Initiative reports from the University of Michigan, created by Dr. Heather Rypkema. 

```{r R coding resources, include = FALSE}
#R coding resources used

#"fadeplot" variations on raincloud plots
#https://dallasnova.rbind.io/post/efficient-data-visualization-with-faded-raincloud-plots-delete-boxplot/

```
